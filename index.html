<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Previous head content remains exactly the same until the script section] -->
</head>
<body>
    <!-- [All HTML content remains exactly the same until the script section] -->

    <script>
        // [Previous script content remains the same until the userState object]

        // User State
        const userState = {
            equipment: ["bodyweight", "dumbbells"],
            battleType: "air",
            currentWorkout: JSON.parse(localStorage.getItem("currentWorkout")) || {
                exercises: { arms: [], chest: [], back: [], abs: [], legs: [] }
            },
            weakMode: JSON.parse(localStorage.getItem("weakMode")) || {},
            lastTotalAssignedCount: 0,
            currentMuscleIndex: parseInt(localStorage.getItem("currentMuscleIndex")) || 0,
            completedWorkout: JSON.parse(localStorage.getItem("completedWorkout")) || false,
            // NEW: Track the last completed cycle position
            lastCompletedCycleIndex: parseInt(localStorage.getItem("lastCompletedCycleIndex")) || 0
        };

        // [Previous functions remain the same until showSuccessMessage]

        // Show success message
        function showSuccessMessage() {
            // Update the last completed cycle position
            userState.lastCompletedCycleIndex = userState.currentMuscleIndex;
            localStorage.setItem("lastCompletedCycleIndex", userState.lastCompletedCycleIndex.toString());
            
            userState.completedWorkout = true;
            localStorage.setItem("completedWorkout", "true");
            workoutDisplay.style.display = "none";
            successBox.style.display = "block";
            lastGenerateClick = 0;
        }

        // Clear all workouts
        function clearAllWorkouts() {
            userState.currentWorkout = { exercises: { arms: [], chest: [], back: [], abs: [], legs: [] } };
            userState.lastTotalAssignedCount = 0;
            // Don't reset currentMuscleIndex here - we want to maintain the cycle position
            userState.weakMode = {};
            userState.completedWorkout = false;
            deathCountInput.value = "1";
            localStorage.setItem("currentWorkout", JSON.stringify(userState.currentWorkout));
            localStorage.removeItem("weakMode");
            localStorage.removeItem("completedWorkout");
            workoutDisplay.style.display = "none";
            exercisesListEl.innerHTML = "";
            successBox.style.display = "none";
            workDoneBtn.disabled = true;
            workDoneBtn.classList.remove('completed');
        }

        // Generate additional exercises based on Strict Cycle
        function generateAdditionalExercises(countToAdd) {
            if (countToAdd <= 0) return;
            if (!userState.currentWorkout.exercises) userState.currentWorkout.exercises = { arms: [], chest: [], back: [], abs: [], legs: [] };

            // Start from the last completed cycle position if this is a new workout
            let cycleIndex = userState.completedWorkout ? userState.lastCompletedCycleIndex : userState.currentMuscleIndex;

            for (let i = 0; i < countToAdd; i++) {
                const muscle = displayOrder[cycleIndex % displayOrder.length];
                const available = (exerciseDB[muscle] || []).filter(ex => ex.equipment.some(e => userState.equipment.includes(e)));
                const currentNames = userState.currentWorkout.exercises[muscle]?.map(ex => ex.name) || [];
                let suitable = available.filter(ex => !currentNames.includes(ex.name));
                if (suitable.length === 0) suitable = available;

                if (suitable.length > 0) {
                    const data = suitable[Math.floor(Math.random() * suitable.length)];
                    if (!userState.currentWorkout.exercises[muscle]) userState.currentWorkout.exercises[muscle] = [];
                    userState.currentWorkout.exercises[muscle].push({
                        ...data, id: generateUniqueId(), reps: data.reps || 12, completed: false
                    });
                } else console.warn(`No available exercises for ${muscle}. Skipping.`);
                cycleIndex++;
            }

            userState.currentMuscleIndex = cycleIndex;
            userState.lastTotalAssignedCount = getTotalAssignedExercises();
            userState.completedWorkout = false; // Reset completion flag when generating new exercises
            
            localStorage.setItem("currentWorkout", JSON.stringify(userState.currentWorkout));
            localStorage.setItem("currentMuscleIndex", userState.currentMuscleIndex.toString());
            localStorage.setItem("completedWorkout", "false");
            renderExercises();
        }

        // [Rest of the code remains exactly the same]
    </script>
</body>
</html>
