<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Thunder</title>
    <style>
        :root {
            --primary: #e63946;
            --dark: #121212;
            --light: #f8f9fa;
            --overlay: rgba(0,0,0,0.7);
            --completed: rgba(255,255,255,0.1);
            --button-color: #a22a29; /* Base color for other buttons */
            --button-border: #e53834; /* Base border */
            --complete-green: #4CAF50; /* Green for Complete/Done */
            --swap-blue: #5bc0de;      /* Light blue for Swap */
            --swap-blue-border: #46b8da;/* Border for Swap */
            /* --- Tooltip Style Variables --- */
            --tooltip-bg: rgba(0,0,0,0.8);
            --tooltip-color: white;
            --tooltip-padding: 5px 10px;
            --tooltip-radius: 5px;
            --tooltip-fontsize: 0.9em;
            --tooltip-fontweight: normal;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }

        #bgImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--overlay);
            z-index: -1;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            padding: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }

        .explanation-text {
            text-align: center;
            font-size: 0.9em;
            color: #ccc;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            backdrop-filter: blur(2px);
        }

        .battle-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 5px;
            backdrop-filter: blur(5px);
            z-index: 10;
        }

        .toggle-container {
            display: flex;
            gap: 15px;
        }

        .toggle-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .death-input-container {
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(5px);
        }

        .death-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Base Input/Button Styles */
        input, button {
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
        }

        input[type="number"] {
            width: 60px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            color: white;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Default Button Style (Uses base red/maroon) */
        button {
            background: var(--button-color);
            color: white;
            cursor: pointer;
            border: 1px solid var(--button-border);
            transition: none;
        }

        /* General Hover for non-specific, non-disabled, non-completed buttons */
         button:not(:disabled):not(.completed):not(#generateBtn):not(.complete-btn):not(.swap-exercise-btn):hover {
             filter: brightness(1.2);
         }


        .workout-display {
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            display: none;
        }

        .exercise-group {
            margin-bottom: 20px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 5px;
        }

        .group-title {
            color: white;
            text-transform: capitalize;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .group-toggle {
            font-size: 1.2em;
            user-select: none;
        }

        .exercises-container {
            margin-left: 25px;
        }

        .exercise {
            background: rgba(255,255,255,0.05);
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }

        .exercise.completed {
            background: var(--completed);
            opacity: 0.7;
        }

        .exercise-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-grow: 1;
        }

        .exercise-name {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            flex-wrap: wrap;
        }

        .exercise-name-text {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
            margin-right: 10px;
        }

        .exercise-difficulty {
            color: gold;
            margin-left: 5px;
        }

        .exercise-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        /* --- Specific Button Styles --- */
        #generateBtn {
           font-weight: bold;
           /* Specific hover if needed, otherwise uses default */
        }
        #generateBtn:not(:disabled):hover {
             filter: brightness(1.2);
        }

        .complete-btn {
            background: var(--complete-green);
            border: 1px solid var(--complete-green);
            padding: 6px 12px;
            min-width: 80px;
            text-align: center;
            white-space: nowrap;
            color: white;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
        }

        .complete-btn.completed {
           /* Color is now default, class used for state */
        }
        /* Prevent hover on disabled/completed */
         .complete-btn:disabled:hover,
         .complete-btn.completed:hover {
            filter: none;
            cursor: default;
        }
         /* Hover for active complete button */
         .complete-btn:not(:disabled):not(.completed):hover {
             filter: brightness(1.1); /* Slightly less bright for green? */
         }


        .swap-exercise-btn {
            background: var(--swap-blue);
            border: 1px solid var(--swap-blue-border);
            color: white;
            padding: 6px 12px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 5px;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            white-space: nowrap;
            gap: 5px;
        }

        .swap-exercise-btn:hover::after {
            content: "Swap for another exercise";
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: var(--tooltip-bg); color: var(--tooltip-color); padding: var(--tooltip-padding);
            border-radius: var(--tooltip-radius); font-size: var(--tooltip-fontsize); font-weight: var(--tooltip-fontweight);
            white-space: nowrap; margin-bottom: 5px; z-index: 1;
        }

        .swap-exercise-btn:not(.disabled):not(:disabled):hover {
            filter: brightness(1.2);
        }

        .swap-exercise-btn.disabled {
            opacity: 0.5; cursor: not-allowed; pointer-events: none;
        }
        /* --- End Specific Button Styles --- */

        .work-done-container {
            display: flex; justify-content: center; align-items: center; margin-top: 20px;
        }

        .work-done-btn {
            display: block; width: 100%; padding: 12px; font-size: 1.1em;
            background: var(--button-color); border: 1px solid var(--button-border); position: relative;
        }
        .work-done-btn:not(:disabled):hover {
             filter: brightness(1.2);
        }

        .work-done-btn.completed { background: var(--complete-green); border-color: var(--complete-green); }
        .work-done-btn:disabled { background: #555; border-color: #777; cursor: not-allowed; }

        .work-done-btn:disabled:hover::after {
            content: "You have work to do still"; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: var(--tooltip-bg); color: var(--tooltip-color); padding: var(--tooltip-padding);
            border-radius: var(--tooltip-radius); font-size: var(--tooltip-fontsize); font-weight: var(--tooltip-fontweight);
            white-space: nowrap; margin-bottom: 5px; z-index: 1;
        }

        .weak-toggle {
            display: flex; align-items: center; gap: 5px; font-size: 0.8em;
            position: relative; margin-top: 5px; color: #ccc; cursor: default; width: fit-content;
        }
        .weak-toggle input[type="checkbox"] { cursor: pointer; }
        .weak-toggle-text { cursor: default; user-select: none; }

        .help-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 14px; height: 14px; background-color: #ccc; color: #333; border-radius: 50%;
            font-size: 0.7em; font-weight: bold; cursor: help; position: relative; user-select: none; line-height: 1;
        }
        .help-icon:hover::after {
            content: "This option reduces the reps by half"; position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
            background: var(--tooltip-bg); color: var(--tooltip-color); padding: var(--tooltip-padding);
            border-radius: var(--tooltip-radius); font-size: var(--tooltip-fontsize); font-weight: var(--tooltip-fontweight);
            white-space: nowrap; width: max-content; z-index: 1;
        }

        .checkbox-option { display: flex; align-items: center; gap: 5px; }
        .checkbox-option input[type="checkbox"] { width: 16px; height: 16px; margin: 0; }

        .toggle-all-container { display: flex; justify-content: flex-end; margin-bottom: 10px; gap: 10px; }
        .toggle-all-btn, .complete-all-btn, .clear-workout-btn {
            background: var(--button-color); border: 1px solid var(--button-border); padding: 5px 10px; font-size: 0.9em; min-width: 100px;
        }
        .toggle-all-btn:hover, .complete-all-btn:hover, .clear-workout-btn:hover {
             filter: brightness(1.2);
        }

        .generate-btn-container { display: flex; justify-content: center; margin-top: 15px; gap: 10px; align-items: center; }
        .generate-main-btn { position: relative; }

        .success-box {
            background: rgba(0,0,0,0.7); padding: 30px; border-radius: 10px; text-align: center;
            margin: 20px auto; max-width: 500px; display: none; backdrop-filter: blur(5px); font-size: 1.5em; color: white;
        }

        .spam-warning {
            position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
            background: var(--tooltip-bg); color: var(--tooltip-color); padding: var(--tooltip-padding);
            border-radius: var(--tooltip-radius); font-size: var(--tooltip-fontsize); font-weight: var(--tooltip-fontweight);
            white-space: nowrap; display: none; z-index: 1;
        }

    </style>
</head>
<body>
    <div class="bg-container">
        <img id="bgImage" src="" alt="Background Image">
        <div class="bg-overlay"></div>
    </div>

    <div class="battle-toggle">
        <span>Battle Type:</span>
        <div class="toggle-container">
            <label class="toggle-option">
                <input type="checkbox" id="airBattles" checked>
                <span class="toggle-label">Air</span>
            </label>
            <label class="toggle-option">
                <input type="checkbox" id="groundBattles">
                <span class="toggle-label">Ground</span>
            </label>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Workout Thunder</h1>
        </header>

        <div class="explanation-text">
            Each death assigns the next exercise in a fixed rotation: Arms → Chest → Back → Abs → Legs → Repeat.
        </div>

        <div class="death-input-container">
            <div class="death-input">
                <span id="deathText">I died</span>
                <input type="number" id="deathCount" min="1" value="1">
                <span id="deathTextEnd">times without getting any kills</span>
            </div>
            <div class="generate-btn-container">
                <div class="generate-main-btn">
                    <button id="generateBtn">GIVE ME MY PUNISHMENT!</button>
                    <span class="spam-warning">If you want to add more exercises, change the number above</span>
                </div>
            </div>
        </div>

        <div class="workout-display" id="workoutDisplay">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2>Your Penalty Workout</h2>
                <div class="toggle-all-container">
                    <button id="toggleAllBtn" class="toggle-all-btn">Collapse All</button>
                    <button id="completeAllBtn" class="complete-all-btn">Complete All</button>
                    <button id="clearWorkoutBtn" class="clear-workout-btn">Clear All</button>
                </div>
            </div>
            <div id="exercisesList"></div>
            <div class="work-done-container">
                <button id="workDoneBtn" class="work-done-btn" disabled>WORK DONE</button>
            </div>
        </div>

        <div id="successBox" class="success-box">
            Nice job. Now get back to the battlefield and git gud.
        </div>
    </div>

    <script>
        // Background Image Cycling
        const bgImages = [
            "./images/img1.jpg",
            "./images/img2.jpg",
            "./images/img3.jpg"
        ];

        const bgImage = document.getElementById("bgImage");
        let bgIndex = parseInt(localStorage.getItem("bgIndex")) || 0;
        if (bgImages.length > 0 && bgImages[bgIndex]) {
            bgImage.src = bgImages[bgIndex];
            bgIndex = (bgIndex + 1) % bgImages.length;
            localStorage.setItem("bgIndex", bgIndex);
        } else {
            console.warn("Background images array empty or paths incorrect.");
        }

        // Exercise Database
        const exerciseDB = {
            arms: [ { name: "Pushups", equipment: ["bodyweight"], difficulty: 2, reps: 15 }, { name: "Bicep Curls", equipment: ["dumbbells"], difficulty: 1, reps: 12 }, { name: "Tricep Dips", equipment: ["bodyweight"], difficulty: 2, reps: 12 }, { name: "Diamond Pushups", equipment: ["bodyweight"], difficulty: 3, reps: 10 }, { name: "Hammer Curls", equipment: ["dumbbells"], difficulty: 1, reps: 12 } ],
            chest: [ { name: "Bench Press", equipment: ["barbell"], difficulty: 3, reps: 10 }, { name: "Dumbbell Press", equipment: ["dumbbells"], difficulty: 2, reps: 12 }, { name: "Pushup Variations", equipment: ["bodyweight"], difficulty: 2, reps: 15 }, { name: "Incline Dumbbell Press", equipment: ["dumbbells"], difficulty: 3, reps: 10 }, { name: "Wide Pushups", equipment: ["bodyweight"], difficulty: 1, reps: 20 } ],
            back: [ { name: "Pull-ups", equipment: ["bodyweight", "pullup_bar"], difficulty: 3, reps: 8 }, { name: "Bent Over Rows", equipment: ["dumbbells", "barbell"], difficulty: 2, reps: 12 }, { name: "Reverse Flyes", equipment: ["dumbbells"], difficulty: 2, reps: 15 }, { name: "Superman", equipment: ["bodyweight"], difficulty: 1, reps: 15 }, { name: "Renegade Rows", equipment: ["dumbbells"], difficulty: 3, reps: 10 } ],
            abs: [ { name: "Russian Twists", equipment: ["bodyweight"], difficulty: 2, reps: 20 }, { name: "Leg Raises", equipment: ["bodyweight"], difficulty: 2, reps: 15 }, { name: "Plank", equipment: ["bodyweight"], difficulty: 1, reps: 60 }, { name: "Crunches", equipment: ["bodyweight"], difficulty: 1, reps: 25 }, { name: "Bicycle Crunches", equipment: ["bodyweight"], difficulty: 2, reps: 20 } ],
            legs: [ { name: "Squats", equipment: ["bodyweight"], difficulty: 2, reps: 20 }, { name: "Lunges", equipment: ["bodyweight"], difficulty: 2, reps: 12 }, { name: "Calf Raises", equipment: ["bodyweight"], difficulty: 1, reps: 25 }, { name: "Glute Bridges", equipment: ["bodyweight"], difficulty: 1, reps: 20 }, { name: "Jump Squats", equipment: ["bodyweight"], difficulty: 3, reps: 15 } ]
        };

        const displayOrder = ["arms", "chest", "back", "abs", "legs"];

        // User State
        const userState = {
            equipment: ["bodyweight", "dumbbells"],
            battleType: "air",
            currentWorkout: JSON.parse(localStorage.getItem("currentWorkout")) || { exercises: { arms: [], chest: [], back: [], abs: [], legs: [] } },
            weakMode: JSON.parse(localStorage.getItem("weakMode")) || {},
            lastTotalAssignedCount: 0,
            currentMuscleIndex: parseInt(localStorage.getItem("currentMuscleIndex")) || 0
        };

        // DOM Elements
        const deathCountInput = document.getElementById("deathCount"), generateBtn = document.getElementById("generateBtn"), exercisesListEl = document.getElementById("exercisesList"), deathTextEl = document.getElementById("deathText"), deathTextEndEl = document.getElementById("deathTextEnd"), airBattlesCheckbox = document.getElementById("airBattles"), groundBattlesCheckbox = document.getElementById("groundBattles"), workDoneBtn = document.getElementById("workDoneBtn"), workoutDisplay = document.getElementById("workoutDisplay"), toggleAllBtn = document.getElementById("toggleAllBtn"), clearWorkoutBtn = document.getElementById("clearWorkoutBtn"), completeAllBtn = document.getElementById("completeAllBtn"), successBox = document.getElementById("successBox"), spamWarningEl = document.querySelector(".spam-warning");
        let lastGenerateClick = 0;

        // --- Utility Functions ---
        function generateUniqueId() { return `ex-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`; }
        function getTotalAssignedExercises() { let c = 0; if (userState.currentWorkout?.exercises) { for (const m of displayOrder) c += userState.currentWorkout.exercises[m]?.length || 0; } return c; }
        function updateDeathText() { deathTextEl.textContent = userState.battleType === "air" ? "I died" : "I lost"; deathTextEndEl.textContent = userState.battleType === "air" ? "times without getting any kills" : "matches"; }
        function handleBattleTypeToggle() { if (this.id === "airBattles" && this.checked) { groundBattlesCheckbox.checked = false; userState.battleType = "air"; } else if (this.id === "groundBattles" && this.checked) { airBattlesCheckbox.checked = false; userState.battleType = "ground"; } else { this.checked = true; return; } updateDeathText(); localStorage.setItem("battleType", userState.battleType); }
        function toggleWeakMode(exId) { userState.weakMode[exId]=!userState.weakMode[exId]; localStorage.setItem("weakMode", JSON.stringify(userState.weakMode)); updateExerciseDisplay(exId); }
        function updateExerciseDisplay(exId) { const el = document.getElementById(exId); if (!el) return; const repsEl = el.querySelector(".exercise-reps"), nameEl = el.querySelector(".exercise-name-text"); const exTxt = nameEl ? nameEl.textContent.toLowerCase() : ''; if (repsEl) { const base = parseInt(repsEl.dataset.baseReps), isWeak = userState.weakMode[exId] || false; const curr = isWeak ? Math.max(1, Math.floor(base / 2)) : base; const lbl = exTxt.includes('plank') ? 'sec' : 'reps'; repsEl.textContent = `(${curr} ${lbl})`; } }
        function completeExercise(exId) { const el = document.getElementById(exId); if (!el) return; el.classList.add("completed"); const cBtn = el.querySelector(".complete-btn"), sBtn = el.querySelector(".swap-exercise-btn"), wChk = el.querySelector(".weak-toggle input"); if (cBtn) { cBtn.textContent = "✓ Done"; cBtn.classList.add("completed"); cBtn.disabled = true; } if (sBtn) { sBtn.classList.add("disabled"); sBtn.disabled = true; } if (wChk) { wChk.disabled = true; } if (userState.currentWorkout?.exercises) { for (const m of displayOrder) { if (!userState.currentWorkout.exercises[m]) continue; const ex = userState.currentWorkout.exercises[m].find(x => x.id === exId); if (ex) { ex.completed = true; localStorage.setItem("currentWorkout", JSON.stringify(userState.currentWorkout)); break; } } } checkAllCompleted(); }
        function swapExercise(exId) { if (!userState.currentWorkout?.exercises) return; let oldEx = null, muscle = null, index = -1; for (const m of displayOrder) { if (!userState.currentWorkout.exercises[m]) continue; const idx = userState.currentWorkout.exercises[m].findIndex(x => x.id === exId); if (idx !== -1) { oldEx = userState.currentWorkout.exercises[m][idx]; muscle = m; index = idx; break; } } if (!oldEx || oldEx.completed) return; const potential = (exerciseDB[muscle] || []).filter(x => x.name !== oldEx.name && x.equipment.some(e => userState.equipment.includes(e))); const current = userState.currentWorkout.exercises[muscle].map(x => x.name); let available = potential.filter(x => !current.includes(x.name)); if (available.length === 0) available = potential; if (available.length === 0) { const btn = document.getElementById(exId)?.querySelector('.swap-exercise-btn'); if (btn) { btn.disabled = true; btn.textContent = 'No Swaps'; setTimeout(() => { if (!oldEx.completed) { btn.disabled = false; btn.innerHTML = '↻ Swap'; } }, 1500); } return; } const data = available[Math.floor(Math.random() * available.length)]; const newEx = { ...data, id: generateUniqueId(), reps: data.reps || 12, completed: false }; userState.currentWorkout.exercises[muscle].splice(index, 1, newEx); if (userState.weakMode[exId]) delete userState.weakMode[exId]; localStorage.setItem("currentWorkout", JSON.stringify(userState.currentWorkout)); localStorage.setItem("weakMode", JSON.stringify(userState.weakMode)); renderExercises(); }
        function clearAllWorkouts() { userState.currentWorkout={exercises:{arms:[],chest:[],back:[],abs:[],legs:[]}}; userState.lastTotalAssignedCount=0; userState.currentMuscleIndex=0; userState.weakMode={}; deathCountInput.value="1"; localStorage.setItem("currentWorkout",JSON.stringify(userState.currentWorkout)); localStorage.setItem("currentMuscleIndex",userState.currentMuscleIndex.toString()); localStorage.removeItem("weakMode"); workoutDisplay.style.display="none"; exercisesListEl.innerHTML=""; successBox.style.display="none"; workDoneBtn.disabled=true; workDoneBtn.classList.remove('completed'); }
        function completeAllExercises() { let ch = false; if (!userState.currentWorkout?.exercises) return; for (const m of displayOrder) { if (!userState.currentWorkout.exercises[m]) continue; userState.currentWorkout.exercises[m].forEach(ex => { if (!ex.completed) { ex.completed = true; ch = true; const el = document.getElementById(ex.id); if(el) completeExercise(ex.id); } }); } if (ch) localStorage.setItem("currentWorkout", JSON.stringify(userState.currentWorkout)); }
        function checkAllCompleted() { if (!userState.currentWorkout?.exercises) { workDoneBtn.disabled=true; workDoneBtn.classList.remove("completed"); return; } let all=true, total=getTotalAssignedExercises(); if(total===0) all=false; else { for(const m of displayOrder){if(!userState.currentWorkout.exercises[m]) continue; for(const ex of userState.currentWorkout.exercises[m]){if(!ex.completed){all=false;break;}} if(!all)break;}} const enable = total > 0 && all; workDoneBtn.disabled = !enable; workDoneBtn.classList.toggle("completed", enable); }
        function showSuccessMessage() { workoutDisplay.style.display="none"; successBox.style.display="block"; lastGenerateClick=0; }

        // --- Strict Cycle Logic ---
        function generateAdditionalExercises(num) { if (num <= 0) return; if (!userState.currentWorkout.exercises) userState.currentWorkout.exercises={arms:[],chest:[],back:[],abs:[],legs:[]}; let idx=userState.currentMuscleIndex; for(let i=0; i<num; i++){ const m=displayOrder[idx%displayOrder.length]; const avail=(exerciseDB[m]||[]).filter(x=>x.equipment.some(e=>userState.equipment.includes(e))); const curr=userState.currentWorkout.exercises[m]?.map(x=>x.name)||[]; let suit=avail.filter(x=>!curr.includes(x.name)); if(suit.length===0)suit=avail; if(suit.length>0){const d=suit[Math.floor(Math.random()*suit.length)]; if(!userState.currentWorkout.exercises[m])userState.currentWorkout.exercises[m]=[]; userState.currentWorkout.exercises[m].push({...d,id:generateUniqueId(),reps:d.reps||12,completed:false});} else console.warn(`No exercises for ${m}`); idx++;} userState.currentMuscleIndex=idx; userState.lastTotalAssignedCount=getTotalAssignedExercises(); localStorage.setItem("currentWorkout",JSON.stringify(userState.currentWorkout)); localStorage.setItem("currentMuscleIndex",userState.currentMuscleIndex.toString()); renderExercises(); }
        function removeExcessExercises(num) { if(num<=0||!userState.currentWorkout.exercises)return; let rem=0, tot=getTotalAssignedExercises(), idx=userState.currentMuscleIndex-1; while(rem<num&&tot>0){ const mIdx=(idx%displayOrder.length+displayOrder.length)%displayOrder.length; const m=displayOrder[mIdx]; const exs=userState.currentWorkout.exercises[m]; if(exs&&exs.length>0){let r=false; for(let i=exs.length-1;i>=0;i--){if(!exs[i].completed){const rmEx=exs.splice(i,1)[0];if(userState.weakMode[rmEx.id])delete userState.weakMode[rmEx.id]; r=true;break;}} if(!r){const rmEx=exs.pop();if(userState.weakMode[rmEx.id])delete userState.weakMode[rmEx.id];} rem++; tot--;} idx--; if(idx<userState.currentMuscleIndex-tot-displayOrder.length-5)break;} userState.currentMuscleIndex=Math.max(0,userState.currentMuscleIndex-rem); userState.lastTotalAssignedCount=tot; localStorage.setItem("currentWorkout",JSON.stringify(userState.currentWorkout)); localStorage.setItem("currentMuscleIndex",userState.currentMuscleIndex.toString()); if(Object.keys(userState.weakMode).length>0)localStorage.setItem("weakMode",JSON.stringify(userState.weakMode)); else localStorage.removeItem("weakMode"); renderExercises(); }

        // Toggle groups
        function toggleAllGroups() { const gs=exercisesListEl.querySelectorAll(".exercise-group"); if(gs.length===0)return; const f=gs[0].querySelector(".exercises-container"); const ex=f&&f.style.display==="none"; gs.forEach(g=>{const c=g.querySelector(".exercises-container"),t=g.querySelector(".group-toggle"); if(c&&t){c.style.display=ex?"block":"none";t.textContent=ex?"🔺":"🔻";}}); toggleAllBtn.textContent=ex?"Collapse All":"Expand All"; }
        function toggleExerciseGroup(g) { const c=g.querySelector(".exercises-container"),t=g.querySelector(".group-toggle"); if(!c||!t)return; const ex=c.style.display==="none"; c.style.display=ex?"block":"none"; t.textContent=ex?"🔺":"🔻"; }

        // Render exercises
        function renderExercises() { exercisesListEl.innerHTML=""; if(!userState.currentWorkout?.exercises)return; let hasEx=false; displayOrder.forEach(m=>{const exs=userState.currentWorkout.exercises[m]; if(exs&&exs.length>0){hasEx=true; const gE=document.createElement("div"); gE.className="exercise-group"; const hE=document.createElement("div"); hE.className="group-header"; hE.addEventListener("click",()=>toggleExerciseGroup(gE)); const tE=document.createElement("div"); tE.className="group-title"; tE.innerHTML=`<span>${m}</span>`; const tgE=document.createElement("div"); tgE.className="group-toggle"; tgE.textContent="🔺"; hE.append(tE,tgE); gE.appendChild(hE); const ct=document.createElement("div"); ct.className="exercises-container"; exs.forEach(ex=>{const el=document.createElement("div"); el.className=`exercise ${ex.completed?'completed':''}`; el.id=ex.id; const bR=ex.reps||12,iW=userState.weakMode[ex.id]||false; const rps=iW?Math.max(1,Math.floor(bR/2)):bR; const dS="★".repeat(ex.difficulty||1); const rT=ex.name.toLowerCase().includes('plank')?`${rps} sec`:`${rps} reps`; el.innerHTML=`<div class="exercise-info"><div class="exercise-name"><div class="exercise-name-text">${ex.name} <span class="exercise-reps" data-base-reps="${bR}">(${rT})</span> <span class="exercise-difficulty">${dS}</span></div><div class="exercise-controls"><button class="complete-btn ${ex.completed?'completed':''}" ${ex.completed?'disabled':''}>${ex.completed?'✓ Done':'Complete'}</button> <button class="swap-exercise-btn ${ex.completed?'disabled':''}" title="Swap" ${ex.completed?'disabled':''}>↻ Swap</button></div></div><label class="checkbox-option weak-toggle"><input type="checkbox" id="weak-${ex.id}" ${iW?"checked":""} ${ex.completed?'disabled':''}> <span class="weak-toggle-text">I'm weak</span> <span class="help-icon">?</span></label></div>`; if(!ex.completed){el.querySelector(".complete-btn").addEventListener("click",()=>completeExercise(ex.id)); el.querySelector(".swap-exercise-btn").addEventListener("click",(e)=>{e.stopPropagation(); swapExercise(ex.id);}); el.querySelector(".weak-toggle input").addEventListener("change",()=>toggleWeakMode(ex.id)); const hp=el.querySelector(".help-icon"); if(hp)hp.addEventListener('click',(e)=>{e.stopPropagation();e.preventDefault();}); const wk=el.querySelector(".weak-toggle-text"); if(wk)wk.addEventListener('click',(e)=>{e.stopPropagation();e.preventDefault();});} else { const cb=el.querySelector(".complete-btn"); if(cb)cb.disabled=true; const sb=el.querySelector(".swap-exercise-btn"); if(sb){sb.classList.add('disabled');sb.disabled=true;} const wc=el.querySelector(".weak-toggle input"); if(wc)wc.disabled=true; } ct.appendChild(el);}); gE.appendChild(ct); exercisesListEl.appendChild(gE);}}); workoutDisplay.style.display=hasEx?"block":"none"; const wDC=!workDoneBtn.disabled&&workDoneBtn.classList.contains('completed'); if(successBox.style.display==='block'&&!wDC)successBox.style.display='none'; const aG=exercisesListEl.querySelectorAll(".exercise-group"); let aC=true; if(aG.length>0){aG.forEach(g=>{const c=g.querySelector(".exercises-container");if(c&&c.style.display!=="none")aC=false;}); toggleAllBtn.textContent=aC?"Expand All":"Collapse All";} else toggleAllBtn.textContent="Collapse All"; checkAllCompleted(); }

        // Generate workout trigger
        function generateWorkout() { const target=parseInt(deathCountInput.value)||0; if(target<0){deathCountInput.value="1";return;} const current=userState.lastTotalAssignedCount; if(target===0){if(current>0)clearAllWorkouts(); else {workoutDisplay.style.display="none";successBox.style.display="none";deathCountInput.value="1";}} else if(target<current)removeExcessExercises(current-target); else if(target>current)generateAdditionalExercises(target-current); else {console.log("Generate: count unchanged."); if(spamWarningEl.style.display!=='block'){spamWarningEl.style.display="block";setTimeout(()=>spamWarningEl.style.display="none",2000);}} }

        // Generate button click handler
        function handleGenerateClick() { const now=Date.now(); if(now-lastGenerateClick<300){console.log("Clicked too quickly."); if(spamWarningEl.style.display!=='block'){spamWarningEl.style.display="block";setTimeout(()=>spamWarningEl.style.display="none",1500);} return;} lastGenerateClick=now; if(successBox.style.display==='block'){clearAllWorkouts(); if(parseInt(deathCountInput.value)<=0)deathCountInput.value="1";} if(userState.lastTotalAssignedCount===0&&parseInt(deathCountInput.value)<=0){deathCountInput.value="1";} generateWorkout(); }

        // --- Initialization ---
        const savedType=localStorage.getItem("battleType"); if(savedType){userState.battleType=savedType; airBattlesCheckbox.checked=(savedType==="air"); groundBattlesCheckbox.checked=(savedType==="ground");} else {airBattlesCheckbox.checked=true; groundBattlesCheckbox.checked=false; userState.battleType="air"; localStorage.setItem("battleType","air");} updateDeathText();
        if(userState.currentWorkout?.exercises&&typeof userState.currentWorkout.exercises==='object'){displayOrder.forEach(m=>{if(!Array.isArray(userState.currentWorkout.exercises[m]))userState.currentWorkout.exercises[m]=[];});} else clearAllWorkouts();
        userState.lastTotalAssignedCount=getTotalAssignedExercises(); userState.currentMuscleIndex=parseInt(localStorage.getItem("currentMuscleIndex"))||0; deathCountInput.value=userState.lastTotalAssignedCount>0?userState.lastTotalAssignedCount:"1";
        if(userState.lastTotalAssignedCount>0)renderExercises(); else workoutDisplay.style.display='none';

        // --- Event Listeners ---
        generateBtn.addEventListener("click", handleGenerateClick); airBattlesCheckbox.addEventListener("change", handleBattleTypeToggle); groundBattlesCheckbox.addEventListener("change", handleBattleTypeToggle); workDoneBtn.addEventListener("click", showSuccessMessage); toggleAllBtn.addEventListener("click", toggleAllGroups); clearWorkoutBtn.addEventListener("click", clearAllWorkouts); completeAllBtn.addEventListener("click", completeAllExercises);

    </script>
</body>
</html>
