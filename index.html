<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Thunder</title>
    <style>
        :root {
            --primary: #e63946;
            --dark: #121212;
            --light: #f8f9fa;
            --overlay: rgba(0,0,0,0.7);
            --completed: rgba(255,255,255,0.1);
            --button-color: #a22a29; /* Base red for some buttons */
            --button-border: #e53834;
            --complete-green: #4CAF50; /* Green for complete */
            --complete-green-border: #6bc76f;
            --tooltip-bg: rgba(0,0,0,0.8);
            --tooltip-color: white;
            --tooltip-padding: 5px 10px;
            --tooltip-radius: 5px;
            --tooltip-fontsize: 0.9em;
            --tooltip-fontweight: normal;
            --swap-blue: #4dabf7;
            --swap-blue-border: #6fc1ff;
            --section-bg: rgba(0,0,0,0.5);
            --section-blur: blur(5px);
            --section-radius: 10px;
            --section-padding: 20px;
            --section-margin-bottom: 20px;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 30px; /* Space for clear cache link */
            background-color: var(--dark); /* Fallback if image fails */
        }

        .bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }

        #bgImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--overlay);
            z-index: -1;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            padding: var(--section-padding);
            background: var(--section-bg);
            border-radius: var(--section-radius);
            backdrop-filter: var(--section-blur);
        }

        .battle-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 5px;
            backdrop-filter: blur(5px);
            z-index: 10;
        }

        .toggle-container {
            display: flex;
            gap: 15px;
        }

        .toggle-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* --- NEW: Medal Showcase Styles --- */
        .medal-showcase {
            position: fixed;
            top: 80px; /* Position below battle toggle */
            right: 20px;
            width: 215px; /* Match battle toggle approx width */
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 5px;
            backdrop-filter: blur(5px);
            z-index: 9; /* Below battle toggle */
            box-sizing: border-box;
        }

        .medal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .medal-title {
            font-weight: bold;
            font-size: 0.95em;
        }

        .medal-toggle {
            font-size: 1.2em;
            user-select: none;
            line-height: 1;
        }

        .medal-content {
            /* Container for count and list, toggled */
        }

        .medal-count {
            font-size: 0.85em;
            color: #ccc;
            margin-bottom: 8px;
        }

        .medal-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            max-height: 100px; /* Limit height */
            overflow-y: auto; /* Add scroll if needed */
            padding-right: 5px; /* Space for scrollbar */
        }

        .medal-emoji {
            font-size: 1.4em;
            cursor: help;
            position: relative; /* Needed for potential JS tooltip positioning */
            line-height: 1;
        }

        #medalTooltip {
            position: fixed; /* Use fixed to escape container bounds */
            background: var(--tooltip-bg);
            color: var(--tooltip-color);
            padding: 8px 12px;
            border-radius: var(--tooltip-radius);
            font-size: 0.85em;
            white-space: pre-wrap; /* Allow wrapping */
            z-index: 20; /* Above everything */
            display: none; /* Hidden by default */
            max-width: 250px; /* Limit width */
            pointer-events: none; /* Don't interfere with mouse */
            line-height: 1.4;
        }
         #medalTooltip strong {
             display: block;
             margin-bottom: 5px;
             font-size: 0.9em;
         }


        .death-input-container {
            background: var(--section-bg);
            padding: var(--section-padding);
            border-radius: var(--section-radius);
            margin-bottom: var(--section-margin-bottom);
            backdrop-filter: var(--section-blur);
        }

        .death-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        input, button {
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            vertical-align: middle;
        }

        input[type="number"] {
            width: 60px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            color: white;
            -moz-appearance: textfield;
            height: 38px;
            box-sizing: border-box;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        button {
            background: var(--button-color);
            color: white;
            cursor: pointer;
            border: 1px solid var(--button-border);
            transition: none; /* Keep transitions off for responsiveness */
            font-family: inherit;
        }

        button:not(:disabled):not(.completed):hover {
            filter: brightness(1.2);
        }
        .complete-btn.completed:hover {
            filter: none;
            cursor: default;
        }

        .equipment-filter-section {
            background: var(--section-bg);
            padding: 15px 20px; /* Adjusted padding */
            border-radius: var(--section-radius);
            backdrop-filter: var(--section-blur);
            margin-bottom: var(--section-margin-bottom); /* Space before workout/summary */
            text-align: center;
        }

        .equipment-filter-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #ccc;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .equipment-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .equipment-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
         .equipment-option input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
         }

        .workout-display {
            background: var(--section-bg);
            padding: var(--section-padding);
            border-radius: var(--section-radius);
            backdrop-filter: var(--section-blur);
            display: none; /* Initially hidden */
        }

        .exercise-group {
            margin-bottom: 20px;
        }
        .exercise-group:last-child {
            margin-bottom: 0; /* Remove margin from last group */
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 5px;
        }

        .group-title {
            color: white;
            text-transform: capitalize;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .group-toggle {
            font-size: 1.2em;
            user-select: none;
        }

        .exercises-container {
            margin-left: 25px; /* Indent exercises */
        }
         /* --- NEW: Summary exercises container uses same class --- */
         .summary-exercises-list .exercises-container {
             margin-left: 0; /* No indent needed for summary */
             padding-left: 10px; /* Small padding */
         }

        /* Exercise Card Layout */
        .exercise {
            background: rgba(255,255,255,0.05);
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .exercise.completed {
            background: var(--completed);
            opacity: 0.7;
        }

        .exercise-top-row {
             display: flex;
             align-items: baseline;
             gap: 8px;
             flex-wrap: wrap;
        }

        .exercise-name-text {
             margin-right: auto;
             font-weight: 500;
        }

        .exercise-reps {
             font-size: 0.9em;
             color: #bbb;
             margin-left: 5px;
             white-space: nowrap;
         }

        .exercise-difficulty {
            color: gold;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .exercise-bottom-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            width: 100%;
            flex-wrap: wrap;
        }

        .exercise-action-buttons {
             display: flex;
             gap: 10px;
        }

        .weak-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
            position: relative;
            color: #ccc;
            cursor: default;
            width: fit-content;
            flex-shrink: 0;
            margin-left: auto;
        }

        .complete-btn {
            background: var(--complete-green);
            border: 1px solid var(--complete-green-border);
            padding: 6px 12px;
            min-width: 80px;
            text-align: center;
            white-space: nowrap;
            color: white;
            font-size: 0.9em;
            border-radius: 5px;
            cursor: pointer;
        }

        .complete-btn.completed { }

        .swap-exercise-btn {
            background: var(--swap-blue);
            border: 1px solid var(--swap-blue-border);
            color: white;
            padding: 6px 12px;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: 5px;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            white-space: nowrap;
            gap: 5px;
        }

        .swap-exercise-btn:hover::after { content: "Swap for another exercise"; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--tooltip-bg); color: var(--tooltip-color); padding: var(--tooltip-padding); border-radius: var(--tooltip-radius); font-size: var(--tooltip-fontsize); font-weight: var(--tooltip-fontweight); white-space: nowrap; margin-bottom: 5px; z-index: 1; }
        .swap-exercise-btn:not(.disabled):not(:disabled):hover { filter: brightness(1.15); }
        .swap-exercise-btn.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }

        .work-done-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .work-done-btn {
            flex-grow: 1;
            padding: 12px;
            font-size: 1.1em;
            background: var(--button-color);
            border: 1px solid var(--button-border);
            position: relative;
        }

        .work-done-btn.completed { background: var(--complete-green); border-color: var(--complete-green-border); }
        .work-done-btn:disabled { background: #555; border-color: #777; cursor: not-allowed; }
        .work-done-btn:disabled:hover::after { content: "You have work to do still"; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--tooltip-bg); color: var(--tooltip-color); padding: var(--tooltip-padding); border-radius: var(--tooltip-radius); font-size: 15px; font-weight: var(--tooltip-fontweight); white-space: nowrap; margin-bottom: 5px; z-index: 1; }

        .weak-toggle input[type="checkbox"] { cursor: pointer; }
        .weak-toggle-text { cursor: default; user-select: none; }
        .help-icon { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; background-color: #ccc; color: #333; border-radius: 50%; font-size: 0.7em; font-weight: bold; cursor: help; position: relative; user-select: none; line-height: 1; }
        .help-icon:hover::after { content: "This option reduces the reps by half"; position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: var(--tooltip-bg); color: var(--tooltip-color); padding: var(--tooltip-padding); border-radius: var(--tooltip-radius); font-size: 15px; font-weight: var(--tooltip-fontweight); white-space: nowrap; width: max-content; z-index: 1; }
        .checkbox-option { display: flex; align-items: center; gap: 5px; }
        .checkbox-option input[type="checkbox"] { width: 16px; height: 16px; margin: 0; }

        .toggle-all-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .toggle-all-btn, .clear-workout-btn {
            background: var(--button-color);
            border: 1px solid var(--button-border);
            padding: 5px 10px;
            font-size: 0.9em;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            min-width: auto;
            text-align: center;
            position: relative;
            box-sizing: border-box;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

         .toggle-all-btn { min-width: 100px; }
         .clear-workout-btn { background: var(--button-color); border-color: var(--button-border); }

        .complete-all-btn { background: var(--complete-green); border: 1px solid var(--complete-green-border); padding: 5px 10px; font-size: 0.9em; border-radius: 5px; color: white; cursor: pointer; min-width: auto; text-align: center; position: relative; box-sizing: border-box; height: 30px; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .complete-all-btn:hover::after, .clear-workout-btn:hover::after { content: attr(data-tooltip); position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: var(--tooltip-bg); color: var(--tooltip-color); padding: var(--tooltip-padding); border-radius: var(--tooltip-radius); font-size: 15px; font-weight: var(--tooltip-fontweight); white-space: nowrap; margin-bottom: 5px; z-index: 1; }

        .generate-btn-container {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap; /* Allow wrap if needed */
        }

        .generate-main-btn { position: relative; }
        #generateBtn { font-weight: bold; }

        #addOneBtn {
            padding: 10px 15px; /* Match generate button */
            font-weight: bold; /* Match generate button */
        }

        /* Session Summary Area Styles */
        #sessionSummaryContent {
             display: none;
             text-align: center;
             color: white;
             padding: 20px 0 0 0; /* Remove bottom padding */
         }
         #sessionSummaryContent img { max-width: 80%; max-height: 250px; height: auto; border-radius: 5px; margin-top: 15px; margin-bottom: 15px; }
         #sessionSummaryContent h2 { font-size: 1.5em; margin-bottom: 10px; }

        /* Container for Summary Toggle Buttons */
         .summary-toggle-container {
             display: flex;
             justify-content: flex-end; /* Align button to the right */
             align-items: center;
             margin-top: 15px; /* Add space above the button */
             margin-bottom: 10px; /* Space below the button */
             gap: 10px;
             padding-right: 20px; /* Align with workout container padding */
         }

         #summaryToggleAllBtn {
             background: var(--button-color);
             border: 1px solid var(--button-border);
             padding: 5px 10px;
             font-size: 0.9em;
             border-radius: 5px;
             color: white;
             cursor: pointer;
             min-width: 100px; /* Match main button */
             text-align: center;
             position: relative;
             box-sizing: border-box;
             height: 30px;
             display: inline-flex;
             align-items: center;
             justify-content: center;
         }

         .summary-exercises-list {
             margin-top: 10px;
             padding-top: 5px;
             padding-right: 0;
         }
         .summary-exercise-item { background: rgba(255,255,255,0.05); padding: 8px 12px; margin-bottom: 6px; border-radius: 5px; font-size: 0.9em; color: #ddd; text-align: left; }

         .summary-done-container {
             margin-top: 25px;
             padding-top: 15px;
             padding-bottom: 20px; /* Add padding to match container */
         }
         .summary-done-btn { background: var(--complete-green); border: 1px solid var(--complete-green-border); color: white; padding: 10px 25px; font-size: 1.1em; font-weight: bold; border-radius: 5px; cursor: pointer; width: 50%; margin: 0 auto; display: block; }
         .summary-done-btn:hover { filter: brightness(1.1); }


        .spam-warning, .number-warning { position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: var(--tooltip-bg); color: var(--tooltip-color); padding: var(--tooltip-padding); border-radius: var(--tooltip-radius); font-size: 15px; font-weight: var(--tooltip-fontweight); white-space: nowrap; display: none; z-index: 10; margin-bottom: 5px; }

        /* Hide regular workout content when summary is shown */
         .workout-display.showing-summary > :not(#sessionSummaryContent) { display: none !important; }

         #clearCacheLink { position: fixed; bottom: 10px; right: 15px; font-size: 0.8em; color: #aaa; cursor: pointer; text-decoration: none; z-index: 5; }
         #clearCacheLink:hover { color: var(--light); text-decoration: underline; }

        .site-description {
            font-size: 0.9em;
            color: #ccc;
            margin-top: 5px;
            margin-bottom: 0;
            font-weight: normal;
            line-height: 1.4;
        }

    </style>
</head>
<body>
    <div class="bg-container">
        <img id="bgImage" src="" alt="Background Image">
        <div class="bg-overlay"></div>
    </div>

    <!-- Top Right Fixed Elements -->
    <div class="battle-toggle">
        <span>Battle Type:</span>
        <div class="toggle-container">
            <label class="toggle-option">
                <input type="checkbox" id="airBattles" checked>
                <span class="toggle-label">Air</span>
            </label>
            <label class="toggle-option">
                <input type="checkbox" id="groundBattles">
                <span class="toggle-label">Ground</span>
            </label>
        </div>
    </div>

    <!-- NEW: Medal Showcase -->
    <div class="medal-showcase" id="medalShowcaseContainer">
        <div class="medal-header" id="medalHeader">
            <span class="medal-title">Medal Display</span>
            <span class="medal-toggle" id="medalToggle">🔺</span>
        </div>
        <div class="medal-content" id="medalContent">
             <div class="medal-count" id="medalCount">Total Medals: 0</div>
             <div class="medal-list" id="medalList">
                 <!-- Medals generated by JS -->
             </div>
        </div>
    </div>
    <!-- NEW: Medal Tooltip Element -->
    <div id="medalTooltip"></div>

    <div class="container">
        <header>
            <h1>Workout Thunder</h1>
            <p class="site-description">Each death adds one exercise in a fixed rotation—Arms, Chest, Back, Abs, Legs, then repeat. The site remembers where you left off, so progress carries over between sessions, and you can clear the current queue without resetting the rotation. It keeps things balanced.</p>
        </header>

        <div class="death-input-container">
            <div class="death-input">
                <span id="deathText">I died</span>
                <input type="number" id="deathCount" min="0" value="1">
                <span id="deathTextEnd">times without getting any kills.</span>
            </div>
            <div class="generate-btn-container">
                <div class="generate-main-btn">
                    <button id="generateBtn">GIVE ME MY PUNISHMENT!</button>
                    <span class="spam-warning">If you want to add more or less exercises, change the number above</span>
                    <span class="number-warning">You have to put a number first</span>
                 </div>
                 <button id="addOneBtn" title="Add another exercise if you’re craving extra punishment">+1</button>
            </div>
        </div>

         <div class="equipment-filter-section">
            <h4>Equipment</h4>
            <div class="equipment-options">
                <label class="equipment-option">
                    <input type="checkbox" id="equip-bodyweight" data-equipment="bodyweight"> Bodyweight
                </label>
                <label class="equipment-option">
                    <input type="checkbox" id="equip-dumbbells" data-equipment="dumbbells"> Dumbbells
                </label>
                <label class="equipment-option">
                    <input type="checkbox" id="equip-kettlebells" data-equipment="kettlebells"> Kettlebells
                </label>
                <label class="equipment-option">
                    <input type="checkbox" id="equip-plate" data-equipment="plate"> Plate
                </label>
            </div>
         </div>

        <!-- Workout/Summary Display Area -->
        <div class="workout-display" id="workoutDisplay">
             <!-- Workout Header Area (hidden when summary shows) -->
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2>Your Penalty Workout</h2>
                <div class="toggle-all-container">
                    <button id="toggleAllBtn" class="toggle-all-btn">Collapse All</button>
                    <button id="clearWorkoutBtn" class="clear-workout-btn" data-tooltip="Delete All Exercises">X</button>
                </div>
             </div>
             <!-- Workout Exercise List Area (hidden when summary shows) -->
             <div id="exercisesList"></div>
             <!-- Action Buttons Area (hidden when summary shows) -->
             <div class="work-done-container">
                <button id="completeAllBtn" class="complete-all-btn" data-tooltip="Complete All Exercises">✓✓</button>
                <button id="workDoneBtn" class="work-done-btn" disabled>WORK DONE</button>
            </div>

             <!-- Session Summary Area (hidden initially) -->
             <div id="sessionSummaryContent">
                <!-- Content generated by JS -->
             </div>
        </div>

    </div>

    <span id="clearCacheLink">Clear cache</span>

    <script>
        // Background Image Cycling
        const bgImages = ["./images/img1.jpg", "./images/img2.jpg", "./images/img3.jpg"];
        const bgImage = document.getElementById("bgImage");
        let bgIndex = parseInt(localStorage.getItem("bgIndex")) || 0;
        // Basic check for images array
        if (bgImages.length > 0 && bgImages[bgIndex]) {
            const img = new Image();
            img.onload = () => { bgImage.src = bgImages[bgIndex]; };
            img.onerror = () => { console.warn(`Background image not found: ${bgImages[bgIndex]}`); };
            img.src = bgImages[bgIndex];
            bgIndex = (bgIndex + 1) % bgImages.length;
            localStorage.setItem("bgIndex", bgIndex);
        } else {
            console.warn("Background images array empty or paths incorrect.");
            // Optionally set a default background color or image here
            document.body.style.backgroundColor = 'var(--dark)'; // Use CSS variable
        }


        // Exercise Database
        const exerciseDB = { arms: [{ name: "Pushups", equipment: ["bodyweight"], difficulty: 2, reps: 15 },{ name: "Bicep Curls", equipment: ["dumbbells", "kettlebells"], difficulty: 1, reps: 12 },{ name: "Tricep Dips", equipment: ["bodyweight"], difficulty: 2, reps: 12 },{ name: "Diamond Pushups", equipment: ["bodyweight"], difficulty: 3, reps: 10 },{ name: "Hammer Curls", equipment: ["dumbbells"], difficulty: 1, reps: 12 },{ name: "Overhead Press", equipment: ["dumbbells", "kettlebells", "plate"], difficulty: 2, reps: 10} ], chest: [{ name: "Bench Press", equipment: ["barbell", "dumbbells"], difficulty: 3, reps: 10 },{ name: "Dumbbell Press", equipment: ["dumbbells"], difficulty: 2, reps: 12 },{ name: "Pushup Variations", equipment: ["bodyweight"], difficulty: 2, reps: 15 },{ name: "Incline Dumbbell Press", equipment: ["dumbbells"], difficulty: 3, reps: 10 },{ name: "Wide Pushups", equipment: ["bodyweight"], difficulty: 1, reps: 20 },{ name: "Plate Pinch Press", equipment: ["plate"], difficulty: 2, reps: 15} ], back: [{ name: "Pull-ups", equipment: ["bodyweight", "pullup_bar"], difficulty: 3, reps: 8 },{ name: "Bent Over Rows", equipment: ["dumbbells", "barbell", "kettlebells"], difficulty: 2, reps: 12 },{ name: "Reverse Flyes", equipment: ["dumbbells"], difficulty: 2, reps: 15 },{ name: "Superman", equipment: ["bodyweight"], difficulty: 1, reps: 15 },{ name: "Renegade Rows", equipment: ["dumbbells", "kettlebells"], difficulty: 3, reps: 10 } ], abs: [{ name: "Russian Twists", equipment: ["bodyweight", "plate", "kettlebell", "dumbbell"], difficulty: 2, reps: 20 },{ name: "Leg Raises", equipment: ["bodyweight"], difficulty: 2, reps: 15 },{ name: "Plank", equipment: ["bodyweight"], difficulty: 1, reps: 60 },{ name: "Crunches", equipment: ["bodyweight", "plate"], difficulty: 1, reps: 25 },{ name: "Bicycle Crunches", equipment: ["bodyweight"], difficulty: 2, reps: 20 } ], legs: [{ name: "Squats", equipment: ["bodyweight", "kettlebells", "dumbbells"], difficulty: 2, reps: 20 },{ name: "Lunges", equipment: ["bodyweight", "dumbbells", "kettlebells", "plate"], difficulty: 2, reps: 12 },{ name: "Calf Raises", equipment: ["bodyweight", "dumbbells", "plate"], difficulty: 1, reps: 25 },{ name: "Glute Bridges", equipment: ["bodyweight", "plate"], difficulty: 1, reps: 20 },{ name: "Jump Squats", equipment: ["bodyweight"], difficulty: 3, reps: 15 },{ name: "Kettlebell Swings", equipment: ["kettlebells"], difficulty: 3, reps: 15} ] };
        const displayOrder = ["arms", "chest", "back", "abs", "legs"];

        // User State
        const userState = {
             equipment: JSON.parse(localStorage.getItem("userEquipment")) || ['bodyweight'],
             battleType: localStorage.getItem("battleType") || "air",
             currentWorkout: JSON.parse(localStorage.getItem("currentWorkout")) || { exercises: { arms: [], chest: [], back: [], abs: [], legs: [] } },
             weakMode: JSON.parse(localStorage.getItem("weakMode")) || {},
             lastTotalAssignedCount: 0, // Calculated on load
             currentMuscleIndex: parseInt(localStorage.getItem("currentMuscleIndex")) || 0,
             completedWorkout: JSON.parse(localStorage.getItem("completedWorkout")) || false,
             lastCompletedCycleIndex: parseInt(localStorage.getItem("lastCompletedCycleIndex")) || 0,
             workoutHistory: JSON.parse(localStorage.getItem("workoutHistory")) || [], // NEW: History
             medalShowcaseCollapsed: JSON.parse(localStorage.getItem("medalShowcaseCollapsed")) || false // NEW: Medal state
        };

        // DOM Elements
        const deathCountInput = document.getElementById("deathCount");
        const generateBtn = document.getElementById("generateBtn");
        const addOneBtn = document.getElementById("addOneBtn");
        const exercisesListEl = document.getElementById("exercisesList");
        const deathTextEl = document.getElementById("deathText");
        const deathTextEndEl = document.getElementById("deathTextEnd");
        const airBattlesCheckbox = document.getElementById("airBattles");
        const groundBattlesCheckbox = document.getElementById("groundBattles");
        const workDoneBtn = document.getElementById("workDoneBtn");
        const workoutDisplay = document.getElementById("workoutDisplay");
        const toggleAllBtn = document.getElementById("toggleAllBtn");
        const clearWorkoutBtn = document.getElementById("clearWorkoutBtn");
        const completeAllBtn = document.getElementById("completeAllBtn");
        const sessionSummaryContentEl = document.getElementById("sessionSummaryContent");
        const spamWarningEl = document.querySelector(".spam-warning");
        const numberWarningEl = document.querySelector(".number-warning");
        const equipmentCheckboxes = document.querySelectorAll('.equipment-options input[type="checkbox"]');
        const clearCacheLink = document.getElementById("clearCacheLink");
        const medalShowcaseContainer = document.getElementById('medalShowcaseContainer'); // NEW
        const medalHeader = document.getElementById('medalHeader'); // NEW
        const medalToggle = document.getElementById('medalToggle'); // NEW
        const medalContent = document.getElementById('medalContent'); // NEW
        const medalCountEl = document.getElementById('medalCount'); // NEW
        const medalListEl = document.getElementById('medalList'); // NEW
        const medalTooltipEl = document.getElementById('medalTooltip'); // NEW
        let lastGenerateClick = 0;

        // Utility Functions
        function generateUniqueId() { return `ex-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`; }
        function getTotalAssignedExercises() { let count = 0; if (userState.currentWorkout && userState.currentWorkout.exercises) { for (const muscle of displayOrder) { count += userState.currentWorkout.exercises[muscle]?.length || 0; } } return count; }
        function updateDeathText() { if (userState.battleType === "air") { deathTextEl.textContent = "I died"; deathTextEndEl.textContent = "times without getting any kills."; } else { deathTextEl.textContent = "I lost"; deathTextEndEl.textContent = "matches"; } }
        function handleBattleTypeToggle() { if (this.id === "airBattles" && this.checked) { groundBattlesCheckbox.checked = false; userState.battleType = "air"; } else if (this.id === "groundBattles" && this.checked) { airBattlesCheckbox.checked = false; userState.battleType = "ground"; } else { this.checked = true; return; } updateDeathText(); localStorage.setItem("battleType", userState.battleType); }
        function toggleWeakMode(exerciseId) { userState.weakMode[exerciseId] = !userState.weakMode[exerciseId]; localStorage.setItem("weakMode", JSON.stringify(userState.weakMode)); updateExerciseDisplay(exerciseId); }
        function updateExerciseDisplay(exerciseId) { const exerciseEl = document.getElementById(exerciseId); if (exerciseEl) { const repsElement = exerciseEl.querySelector(".exercise-reps"); const exerciseNameElement = exerciseEl.querySelector(".exercise-name-text"); const exerciseText = exerciseNameElement ? exerciseNameElement.firstChild.textContent.trim().toLowerCase() : ''; if (repsElement) { const baseReps = parseInt(repsElement.dataset.baseReps); const isWeak = userState.weakMode[exerciseId] || false; const currentReps = isWeak ? Math.max(1, Math.floor(baseReps / 2)) : baseReps; const repsLabel = exerciseText.includes('plank') ? 'sec' : 'reps'; repsElement.textContent = `(${currentReps} ${repsLabel})`; } } }
        function completeExercise(exerciseId) { const exerciseEl = document.getElementById(exerciseId); if (exerciseEl) { exerciseEl.classList.add("completed"); const completeBtn = exerciseEl.querySelector(".complete-btn"); const swapBtn = exerciseEl.querySelector(".swap-exercise-btn"); const weakToggleCheckbox = exerciseEl.querySelector(".weak-toggle input"); if (completeBtn) { completeBtn.textContent = "✓ Done"; completeBtn.classList.add("completed"); completeBtn.disabled = true; } if (swapBtn) { swapBtn.classList.add("disabled"); swapBtn.disabled = true; } if (weakToggleCheckbox) { weakToggleCheckbox.disabled = true; } if (userState.currentWorkout && userState.currentWorkout.exercises) { for (const muscle of displayOrder) { if (!userState.currentWorkout.exercises[muscle]) continue; const exercise = userState.currentWorkout.exercises[muscle].find(ex => ex.id === exerciseId); if (exercise) { exercise.completed = true; localStorage.setItem("currentWorkout", JSON.stringify(userState.currentWorkout)); break; } } } checkAllCompleted(); } }
        function swapExercise(exerciseIdToSwap) { if (!userState.currentWorkout || !userState.currentWorkout.exercises) return; let oldExercise = null, muscleGroup = null, exerciseIndex = -1; for (const muscle of displayOrder) { if (!userState.currentWorkout.exercises[muscle]) continue; const index = userState.currentWorkout.exercises[muscle].findIndex(ex => ex.id === exerciseIdToSwap); if (index !== -1) { oldExercise = userState.currentWorkout.exercises[muscle][index]; muscleGroup = muscle; exerciseIndex = index; break; } } if (!oldExercise || oldExercise.completed) return; const potentialReplacements = (exerciseDB[muscleGroup] || []).filter(ex => ex.name !== oldExercise.name && ex.equipment.some(e => userState.equipment.includes(e))); const currentNames = userState.currentWorkout.exercises[muscleGroup].map(ex => ex.name); let availableReplacements = potentialReplacements.filter(ex => !currentNames.includes(ex.name)); if (availableReplacements.length === 0) availableReplacements = potentialReplacements; if (availableReplacements.length === 0) { const swapBtn = document.getElementById(exerciseIdToSwap)?.querySelector('.swap-exercise-btn'); if (swapBtn) { swapBtn.disabled = true; swapBtn.textContent = 'No Swaps'; setTimeout(() => { const currentEx = userState.currentWorkout.exercises[muscleGroup]?.find(ex => ex.id === exerciseIdToSwap); if (currentEx && !currentEx.completed && swapBtn) { swapBtn.disabled = false; swapBtn.innerHTML = '↻ Swap'; } }, 1500); } console.log(`No valid swap found for ${oldExercise.name}. Removing.`); userState.currentWorkout.exercises[muscleGroup].splice(exerciseIndex, 1); if (userState.weakMode[exerciseIdToSwap]) delete userState.weakMode[exerciseIdToSwap]; localStorage.setItem("currentWorkout", JSON.stringify(userState.currentWorkout)); localStorage.setItem("weakMode", JSON.stringify(userState.weakMode)); renderExercises(); return; } const newExerciseData = availableReplacements[Math.floor(Math.random() * availableReplacements.length)]; const newExercise = { ...newExerciseData, id: generateUniqueId(), reps: newExerciseData.reps || 12, completed: false }; userState.currentWorkout.exercises[muscleGroup].splice(exerciseIndex, 1, newExercise); if (userState.weakMode[exerciseIdToSwap]) delete userState.weakMode[exerciseIdToSwap]; localStorage.setItem("currentWorkout", JSON.stringify(userState.currentWorkout)); localStorage.setItem("weakMode", JSON.stringify(userState.weakMode)); renderExercises(); }
        function clearAllWorkouts() { userState.currentWorkout = { exercises: { arms: [], chest: [], back: [], abs: [], legs: [] } }; userState.lastTotalAssignedCount = 0; userState.weakMode = {}; userState.completedWorkout = false; deathCountInput.value = "1"; localStorage.setItem("currentWorkout", JSON.stringify(userState.currentWorkout)); localStorage.removeItem("weakMode"); localStorage.removeItem("completedWorkout"); sessionSummaryContentEl.style.display = "none"; workoutDisplay.classList.remove('showing-summary'); workoutDisplay.style.display = "none"; exercisesListEl.innerHTML = ""; workDoneBtn.disabled = true; workDoneBtn.classList.remove('completed'); }
        function completeAllExercises() { let changed = false; if (!userState.currentWorkout?.exercises) return; for (const muscle of displayOrder) { if (!userState.currentWorkout.exercises[muscle]) continue; userState.currentWorkout.exercises[muscle].forEach(ex => { if (!ex.completed) { ex.completed = true; changed = true; const el = document.getElementById(ex.id); if(el) completeExercise(ex.id); } }); } if (changed) localStorage.setItem("currentWorkout", JSON.stringify(userState.currentWorkout)); checkAllCompleted(); }
        function checkAllCompleted() { if (!userState.currentWorkout?.exercises) { workDoneBtn.disabled = true; workDoneBtn.classList.remove("completed"); return; } let allCompleted = true; const totalExercises = getTotalAssignedExercises(); if (totalExercises === 0) { allCompleted = false; } else { for (const muscle of displayOrder) { if (!userState.currentWorkout.exercises[muscle]) continue; for (const ex of userState.currentWorkout.exercises[muscle]) { if (!ex.completed) { allCompleted = false; break; } } if (!allCompleted) break; } } const enableButton = totalExercises > 0 && allCompleted; workDoneBtn.disabled = !enableButton; workDoneBtn.classList.toggle("completed", enableButton); }
        function formatWorkoutForSummary(workoutData) { const formatted = { total: 0, exercises: {}, flatList: [] }; // Add flatList for history
         if (!workoutData || !workoutData.exercises) return formatted;
         displayOrder.forEach(muscle => {
             if (workoutData.exercises[muscle] && workoutData.exercises[muscle].length > 0) {
                 const completedInGroup = [];
                 workoutData.exercises[muscle].forEach(ex => {
                     if (ex.completed) {
                         const baseReps = ex.reps || 12;
                         const isWeak = userState.weakMode[ex.id] || false;
                         const actualReps = isWeak ? Math.max(1, Math.floor(baseReps / 2)) : baseReps;
                         const repsLabel = ex.name.toLowerCase().includes('plank') ? 'sec' : 'reps';
                         const exerciseSummary = { name: ex.name, reps: actualReps, label: repsLabel };
                         completedInGroup.push(exerciseSummary);
                         formatted.flatList.push(`${ex.name} (${actualReps} ${repsLabel})`); // Add to flat list
                         formatted.total++;
                     }
                 });
                 if (completedInGroup.length > 0) {
                     formatted.exercises[muscle] = completedInGroup;
                 }
             }
         });
         return formatted;
        }

        // --- MODIFIED: showSuccessMessage ---
        function showSuccessMessage() {
            const summaryData = formatWorkoutForSummary(userState.currentWorkout);
            if (summaryData.total === 0) { console.log("No completed exercises to save or show."); return; }

            // --- NEW: Save Workout History ---
            const currentDate = new Date().toLocaleDateString();
            const historyEntry = {
                date: currentDate,
                exercises: summaryData.flatList // Use the flat list
            };
            userState.workoutHistory.push(historyEntry);
            localStorage.setItem("workoutHistory", JSON.stringify(userState.workoutHistory));
            renderMedalShowcase(); // Update medal display immediately
            // --- End New History Save ---

            // Save state FIRST (cycle index, completed flag)
            userState.lastCompletedCycleIndex = userState.currentMuscleIndex;
            localStorage.setItem("lastCompletedCycleIndex", userState.lastCompletedCycleIndex.toString());
            userState.completedWorkout = true;
            localStorage.setItem("completedWorkout", "true");


            // Prepare Summary HTML - MODIFIED for default collapse
            const summaryHtml = `
                <h2>Session Complete! (${summaryData.total} Exercises Done)</h2>
                <img src="./images/Dale-Cooper_Thumbs_Up.gif" alt="Thumbs Up">
                <div class="summary-toggle-container">
                     <button id="summaryToggleAllBtn" class="toggle-all-btn">Expand All</button> <!-- Default text: Expand All -->
                 </div>
                <div class="summary-exercises-list">
                    ${displayOrder.map(muscle => {
                        if (summaryData.exercises[muscle] && summaryData.exercises[muscle].length > 0) {
                            // Use same group structure as main workout list
                            return `
                                <div class="exercise-group">
                                    <div class="group-header">
                                        <div class="group-title"><span>${muscle.charAt(0).toUpperCase() + muscle.slice(1)}</span></div>
                                        <div class="group-toggle">🔻</div> <!-- Default Icon: Collapsed -->
                                    </div>
                                    <div class="exercises-container" style="display: none;"> <!-- Default State: Collapsed -->
                                        ${summaryData.exercises[muscle].map(ex => `
                                            <div class="summary-exercise-item"> ${ex.name} (${ex.reps} ${ex.label}) </div>
                                        `).join('')}
                                    </div>
                                </div>`;
                        }
                        return '';
                    }).join('')}
                </div>
                <div class="summary-done-container">
                    <button id="summaryDoneBtn" class="summary-done-btn">DONE</button>
                </div>
            `;

            // Update the DOM
            sessionSummaryContentEl.innerHTML = summaryHtml;
            sessionSummaryContentEl.style.display = 'block';
            workoutDisplay.style.display = 'block';
            workoutDisplay.classList.add('showing-summary');

            // Add listeners for dynamically added elements
            const summaryGroupHeaders = sessionSummaryContentEl.querySelectorAll(".group-header");
            summaryGroupHeaders.forEach(header => { header.addEventListener("click", () => { const group = header.closest('.exercise-group'); if (group) { toggleExerciseGroup(group, null, sessionSummaryContentEl, sessionSummaryContentEl.querySelector("#summaryToggleAllBtn")); } }); });
            const summaryDoneBtn = sessionSummaryContentEl.querySelector("#summaryDoneBtn");
            if (summaryDoneBtn) { summaryDoneBtn.addEventListener('click', () => { clearAllWorkouts(); }); }
            const summaryToggleBtn = sessionSummaryContentEl.querySelector("#summaryToggleAllBtn");
             if (summaryToggleBtn) {
                summaryToggleBtn.addEventListener('click', () => toggleAllGroups(sessionSummaryContentEl, summaryToggleBtn));
             }

            lastGenerateClick = 0;
        }


        function generateAdditionalExercises(countToAdd) { if (countToAdd <= 0) return; if (!userState.currentWorkout.exercises) userState.currentWorkout.exercises = { arms: [], chest: [], back: [], abs: [], legs: [] }; let cycleIndex = userState.completedWorkout ? userState.lastCompletedCycleIndex : userState.currentMuscleIndex; let addedCount = 0; let attempts = 0; const maxAttempts = countToAdd * displayOrder.length * 2; while (addedCount < countToAdd && attempts < maxAttempts) { const muscle = displayOrder[cycleIndex % displayOrder.length]; const available = (exerciseDB[muscle] || []).filter(ex => ex.equipment.some(e => userState.equipment.includes(e))); const currentNames = userState.currentWorkout.exercises[muscle]?.map(ex => ex.name) || []; let suitable = available.filter(ex => !currentNames.includes(ex.name)); if (suitable.length === 0) suitable = available; if (suitable.length > 0) { const data = suitable[Math.floor(Math.random() * suitable.length)]; if (!userState.currentWorkout.exercises[muscle]) userState.currentWorkout.exercises[muscle] = []; userState.currentWorkout.exercises[muscle].push({ ...data, id: generateUniqueId(), reps: data.reps || 12, completed: false }); addedCount++; } else { console.warn(`No available exercises for ${muscle} with current equipment. Skipping this cycle.`); } cycleIndex++; attempts++; } if (attempts >= maxAttempts && addedCount < countToAdd) { console.warn(`Could only add ${addedCount}/${countToAdd} exercises due to equipment constraints.`); } userState.currentMuscleIndex = cycleIndex; userState.lastTotalAssignedCount = getTotalAssignedExercises(); userState.completedWorkout = false; localStorage.setItem("currentWorkout", JSON.stringify(userState.currentWorkout)); localStorage.setItem("currentMuscleIndex", userState.currentMuscleIndex.toString()); localStorage.setItem("completedWorkout", "false"); renderExercises(); }
        function removeExcessExercises(countToRemove) { if (countToRemove <= 0 || !userState.currentWorkout.exercises) return; let removedCount = 0; let currentTotal = getTotalAssignedExercises(); let cycleIndex = userState.currentMuscleIndex - 1; while (removedCount < countToRemove && currentTotal > 0) { const muscleIndex = (cycleIndex % displayOrder.length + displayOrder.length) % displayOrder.length; const muscle = displayOrder[muscleIndex]; const exercises = userState.currentWorkout.exercises[muscle]; if (exercises && exercises.length > 0) { let removed = false; for (let i = exercises.length - 1; i >= 0; i--) { if (!exercises[i].completed) { const removedEx = exercises.splice(i, 1)[0]; if (userState.weakMode[removedEx.id]) delete userState.weakMode[removedEx.id]; removed = true; break; } } if (!removed) { const removedEx = exercises.pop(); if (removedEx && userState.weakMode[removedEx.id]) delete userState.weakMode[removedEx.id]; } removedCount++; currentTotal--; } cycleIndex--; if (cycleIndex < userState.currentMuscleIndex - currentTotal - displayOrder.length * 2) { console.warn("Breaking remove loop - safety check."); break; } } userState.currentMuscleIndex = Math.max(0, userState.currentMuscleIndex - removedCount); userState.lastTotalAssignedCount = currentTotal; localStorage.setItem("currentWorkout", JSON.stringify(userState.currentWorkout)); localStorage.setItem("currentMuscleIndex", userState.currentMuscleIndex.toString()); if (Object.keys(userState.weakMode).length > 0) localStorage.setItem("weakMode", JSON.stringify(userState.weakMode)); else localStorage.removeItem("weakMode"); renderExercises(); }

        // --- MODIFIED: toggleAllGroups accepts context and button ---
        function toggleAllGroups(contextElement = exercisesListEl, buttonElement = toggleAllBtn) {
            const groups = contextElement.querySelectorAll(".exercise-group");
            if (groups.length === 0) return;
            const firstGroupContainer = groups[0]?.querySelector(".exercises-container");
            // Determine if we should expand: If the first container doesn't exist or is hidden
            const shouldExpand = !firstGroupContainer || firstGroupContainer.style.display === "none";
            groups.forEach(group => {
                // Pass the explicit state (expand or collapse) to toggleExerciseGroup
                toggleExerciseGroup(group, shouldExpand, contextElement, buttonElement);
            });
            buttonElement.textContent = shouldExpand ? "Collapse All" : "Expand All";
        }

        // --- MODIFIED: toggleExerciseGroup accepts context/button for update ---
        function toggleExerciseGroup(groupEl, forceExpand = null, contextElement = exercisesListEl, buttonElement = toggleAllBtn) {
             if (!groupEl) return;
             const container = groupEl.querySelector(".exercises-container");
             const toggle = groupEl.querySelector(".group-toggle");
             if (!container || !toggle) return;

             let expand;
             if (forceExpand !== null) {
                 expand = forceExpand; // Use forced state if provided
             } else {
                 expand = container.style.display === "none"; // Otherwise, toggle based on current state
             }

             container.style.display = expand ? "block" : "none";
             toggle.textContent = expand ? "🔺" : "🔻";

             // Update the main "Toggle All" button state only if not in summary view OR if called from summary context
             if (contextElement === exercisesListEl || contextElement === sessionSummaryContentEl) {
                 updateToggleAllButtonState(contextElement, buttonElement);
             }
        }
        // --- MODIFIED: updateToggleAllButtonState accepts context/button ---
        function updateToggleAllButtonState(contextElement = exercisesListEl, buttonElement = toggleAllBtn) {
             const allGroups = contextElement.querySelectorAll(".exercise-group");
             let allCollapsed = true;
             if (allGroups.length > 0) {
                 allGroups.forEach(g => {
                     const c = g.querySelector(".exercises-container");
                     // If any container is visible (not 'none'), then not all are collapsed
                     if (c && c.style.display !== "none") {
                         allCollapsed = false;
                     }
                 });
                 buttonElement.textContent = allCollapsed ? "Expand All" : "Collapse All";
             } else {
                 // Default state if no groups
                 buttonElement.textContent = "Collapse All";
             }
        }


        // --- MODIFIED: renderExercises layout ---
        function renderExercises() {
             sessionSummaryContentEl.style.display = 'none';
             workoutDisplay.classList.remove('showing-summary');
             exercisesListEl.innerHTML = "";
             if (!userState.currentWorkout?.exercises) return;

             let hasExercises = false;
             // Check current state of the main toggle button BEFORE rendering
             const isInitiallyCollapsed = toggleAllBtn.textContent === "Expand All";

             displayOrder.forEach(muscle => {
                 const exercises = userState.currentWorkout.exercises[muscle];
                 if (exercises && exercises.length > 0) {
                     hasExercises = true;
                     const groupEl = document.createElement("div"); groupEl.className = "exercise-group";
                     const headerEl = document.createElement("div"); headerEl.className = "group-header";
                     // Use default context/button for main workout list toggle
                     headerEl.addEventListener("click", () => toggleExerciseGroup(groupEl));
                     const titleEl = document.createElement("div"); titleEl.className = "group-title"; titleEl.innerHTML = `<span>${muscle.charAt(0).toUpperCase() + muscle.slice(1)}</span>`;
                     const toggleEl = document.createElement("div"); toggleEl.className = "group-toggle";
                     toggleEl.textContent = isInitiallyCollapsed ? "🔻" : "🔺"; // Set icon based on initial state
                     headerEl.append(titleEl, toggleEl); groupEl.appendChild(headerEl);

                     const cont = document.createElement("div"); cont.className = "exercises-container";
                     cont.style.display = isInitiallyCollapsed ? "none" : "block"; // Set display based on initial state

                     exercises.forEach(ex => {
                         const el = document.createElement("div"); el.className = `exercise ${ex.completed ? 'completed' : ''}`; el.id = ex.id;
                         const baseReps = ex.reps || 12, isWeak = userState.weakMode[ex.id] || false;
                         const reps = isWeak ? Math.max(1, Math.floor(baseReps / 2)) : baseReps;
                         const diffStars = "★".repeat(ex.difficulty || 1);
                         const repsTxt = ex.name.toLowerCase().includes('plank') ? `${reps} sec` : `${reps} reps`;

                         el.innerHTML = `
                            <div class="exercise-top-row">
                                <span class="exercise-name-text">
                                    ${ex.name} <span class="exercise-reps" data-base-reps="${baseReps}">(${repsTxt})</span>
                                </span>
                                <span class="exercise-difficulty">${diffStars}</span>
                            </div>
                            <div class="exercise-bottom-row">
                                <div class="exercise-action-buttons">
                                     <button class="complete-btn ${ex.completed ? 'completed' : ''}" ${ex.completed ? 'disabled' : ''}>${ex.completed ? '✓ Done' : 'Complete'}</button>
                                     <button class="swap-exercise-btn ${ex.completed ? 'disabled' : ''}" title="Swap Exercise" ${ex.completed ? 'disabled' : ''}>↻ Swap</button>
                                </div>
                                <label class="checkbox-option weak-toggle">
                                    <input type="checkbox" id="weak-${ex.id}" ${isWeak ? "checked" : ""} ${ex.completed ? 'disabled' : ''}>
                                    <span class="weak-toggle-text">I'm weak</span>
                                    <span class="help-icon">?</span>
                                </label>
                            </div>`;

                         if (!ex.completed) {
                             el.querySelector(".complete-btn").addEventListener("click", () => completeExercise(ex.id));
                             el.querySelector(".swap-exercise-btn").addEventListener("click", (e) => { e.stopPropagation(); swapExercise(ex.id); });
                             el.querySelector(".weak-toggle input").addEventListener("change", () => toggleWeakMode(ex.id));
                             const help = el.querySelector(".help-icon"); if(help) help.addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); });
                             const weakText = el.querySelector(".weak-toggle-text"); if(weakText) weakText.addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); });
                         } else {
                             const cBtn = el.querySelector(".complete-btn"); if(cBtn) { cBtn.classList.add('completed'); cBtn.disabled = true; cBtn.textContent = '✓ Done'; }
                             const sBtn = el.querySelector(".swap-exercise-btn"); if(sBtn) { sBtn.classList.add('disabled'); sBtn.disabled = true; }
                             const wChk = el.querySelector(".weak-toggle input"); if(wChk) wChk.disabled = true;
                         }
                         cont.appendChild(el);
                     });
                     groupEl.appendChild(cont); exercisesListEl.appendChild(groupEl);
                 }
            });
            workoutDisplay.style.display = hasExercises || sessionSummaryContentEl.style.display === 'block' ? "block" : "none";
            // Update button state after rendering, based on the actual rendered state (important if initialized collapsed)
            updateToggleAllButtonState();
            checkAllCompleted();
         }
        function generateWorkout() { numberWarningEl.style.display = "none"; spamWarningEl.style.display = "none"; const deathCountValue = deathCountInput.value; if (deathCountValue === "" || deathCountValue === "0") { numberWarningEl.style.display = "block"; setTimeout(() => numberWarningEl.style.display = "none", 2000); return; } const targetDeaths = parseInt(deathCountValue); if (isNaN(targetDeaths) || targetDeaths < 0) { numberWarningEl.style.display = "block"; setTimeout(() => numberWarningEl.style.display = "none", 2000); return; } const currentCount = userState.lastTotalAssignedCount; if (targetDeaths < currentCount) { removeExcessExercises(currentCount - targetDeaths); } else if (targetDeaths > currentCount) { generateAdditionalExercises(targetDeaths - currentCount); } else { console.log("Generate called but count hasn't changed."); if (spamWarningEl.style.display !== 'block') { spamWarningEl.style.display = "block"; setTimeout(() => spamWarningEl.style.display = "none", 2000); } } if (targetDeaths !== currentCount) { userState.completedWorkout = false; localStorage.setItem("completedWorkout", "false"); } }
        function handleGenerateClick() { const now = Date.now(); numberWarningEl.style.display = "none"; spamWarningEl.style.display = "none"; const targetDeathsValue = deathCountInput.value; const targetDeaths = parseInt(targetDeathsValue); if (now - lastGenerateClick < 300) { console.log("Generate button clicked too quickly."); if (targetDeathsValue === "" || targetDeathsValue === "0" || isNaN(targetDeaths) || targetDeaths < 0) { if (numberWarningEl.style.display !== 'block') { numberWarningEl.style.display = "block"; setTimeout(() => numberWarningEl.style.display = "none", 1500); } } else if (targetDeaths > 0 && targetDeaths === userState.lastTotalAssignedCount) { if (spamWarningEl.style.display !== 'block') { spamWarningEl.style.display = "block"; setTimeout(() => spamWarningEl.style.display = "none", 1500); } } return; } lastGenerateClick = now; sessionSummaryContentEl.style.display = 'none'; workoutDisplay.classList.remove('showing-summary'); if (userState.completedWorkout) { userState.completedWorkout = false; localStorage.setItem("completedWorkout", "false"); } generateWorkout(); }
        function reevaluateWorkoutExercises() { if (!userState.currentWorkout?.exercises) return; let changesMade = false; let shouldRerender = false; for (const muscle of displayOrder) { if (!userState.currentWorkout.exercises[muscle]) continue; for (let i = userState.currentWorkout.exercises[muscle].length - 1; i >= 0; i--) { const exercise = userState.currentWorkout.exercises[muscle][i]; if (!exercise.completed) { const isValid = exercise.equipment.some(e => userState.equipment.includes(e)); if (!isValid) { console.log(`Exercise "${exercise.name}" no longer valid with current equipment. Attempting swap.`); const originalLength = userState.currentWorkout.exercises[muscle].length; swapExercise(exercise.id); shouldRerender = true; // swapExercise calls render, but we flag it anyway break; // Restart check for this muscle group after swap } } } } if (shouldRerender) { console.log("Re-rendering after equipment change validation."); // renderExercises() // swapExercise already calls render, avoid double render } }
        function handleEquipmentChange(event) { const checkbox = event.target; const equipmentType = checkbox.dataset.equipment; if (!equipmentType) return; if (checkbox.checked) { if (!userState.equipment.includes(equipmentType)) { userState.equipment.push(equipmentType); } } else { const index = userState.equipment.indexOf(equipmentType); if (index > -1) { userState.equipment.splice(index, 1); } if (userState.equipment.length === 0) { console.warn("Cannot uncheck the last piece of equipment."); checkbox.checked = true; userState.equipment.push(equipmentType); return; } } localStorage.setItem("userEquipment", JSON.stringify(userState.equipment)); console.log("Updated equipment:", userState.equipment); reevaluateWorkoutExercises(); }
        function handleAddOneClick() {
             numberWarningEl.style.display = "none";
             spamWarningEl.style.display = "none";
             let currentVal = parseInt(deathCountInput.value);
             if (isNaN(currentVal) || currentVal < 0) { currentVal = userState.lastTotalAssignedCount > 0 ? userState.lastTotalAssignedCount : 0; } // Base on actual count if input invalid
             const newVal = currentVal + 1;
             deathCountInput.value = newVal;
             handleGenerateClick(); // Trigger the generation logic
        }

        // --- NEW: Medal Showcase Functions ---
        function renderMedalShowcase() {
             medalListEl.innerHTML = ''; // Clear existing medals
             const history = userState.workoutHistory;
             medalCountEl.textContent = `Total Medals: ${history.length}`;

             history.forEach((entry, index) => {
                 const medalSpan = document.createElement('span');
                 medalSpan.className = 'medal-emoji';
                 medalSpan.textContent = '🎖️';
                 // Store data for the tooltip
                 medalSpan.dataset.date = entry.date;
                 medalSpan.dataset.exercises = JSON.stringify(entry.exercises); // Store as JSON string

                 medalSpan.addEventListener('mouseover', (event) => showMedalTooltip(event, entry));
                 medalSpan.addEventListener('mouseout', hideMedalTooltip);
                 medalSpan.addEventListener('mousemove', positionMedalTooltip); // Update position while moving

                 medalListEl.appendChild(medalSpan);
             });

             // Apply initial collapsed state
             toggleMedalShowcase(userState.medalShowcaseCollapsed, false); // false = don't save state again
        }

        function showMedalTooltip(event, entry) {
             const exercisesHtml = entry.exercises.map(ex => ` • ${ex}`).join('\n');
             medalTooltipEl.innerHTML = `<strong>${entry.date}</strong>${exercisesHtml}`;
             positionMedalTooltip(event); // Initial position
             medalTooltipEl.style.display = 'block';
        }

        function hideMedalTooltip() {
             medalTooltipEl.style.display = 'none';
        }

        function positionMedalTooltip(event) {
            // Position tooltip near the cursor
            const offsetX = 15; // Offset from cursor X
            const offsetY = 10; // Offset from cursor Y
            let x = event.clientX + offsetX;
            let y = event.clientY + offsetY;

            // Prevent tooltip going off-screen
            const tooltipRect = medalTooltipEl.getBoundingClientRect(); // Get dimensions *after* setting content
             if (x + tooltipRect.width > window.innerWidth) {
                x = event.clientX - tooltipRect.width - offsetX; // Flip to left
             }
             if (y + tooltipRect.height > window.innerHeight) {
                y = event.clientY - tooltipRect.height - offsetY; // Flip above
             }
              // Ensure it doesn't go off the top/left either
              if (x < 0) x = offsetX;
              if (y < 0) y = offsetY;


             medalTooltipEl.style.left = `${x}px`;
             medalTooltipEl.style.top = `${y}px`;
        }


        function toggleMedalShowcase(forceCollapse = null, saveState = true) {
            let collapse;
            if (forceCollapse !== null) {
                collapse = forceCollapse;
            } else {
                collapse = medalContent.style.display !== 'none';
            }

            medalContent.style.display = collapse ? 'none' : 'block';
            medalToggle.textContent = collapse ? '🔻' : '🔺'; // Opposite logic to groups: 🔻 means collapsed here

            if (saveState) {
                userState.medalShowcaseCollapsed = collapse;
                localStorage.setItem("medalShowcaseCollapsed", JSON.stringify(collapse));
            }
        }

        // Initialization
        function initializeApp() {
            // Battle Type
            userState.battleType = localStorage.getItem("battleType") || "air";
            airBattlesCheckbox.checked = (userState.battleType === "air");
            groundBattlesCheckbox.checked = (userState.battleType === "ground");
            updateDeathText();

            // Equipment
            userState.equipment = JSON.parse(localStorage.getItem("userEquipment")) || ['bodyweight'];
            equipmentCheckboxes.forEach(checkbox => {
                const equipmentType = checkbox.dataset.equipment;
                checkbox.checked = userState.equipment.includes(equipmentType);
                checkbox.addEventListener('change', handleEquipmentChange);
            });

            // Workout State & Display
            userState.currentWorkout = JSON.parse(localStorage.getItem("currentWorkout")) || { exercises: { arms: [], chest: [], back: [], abs: [], legs: [] } };
            // Ensure exercise arrays exist
            if (userState.currentWorkout?.exercises && typeof userState.currentWorkout.exercises === 'object') {
                 displayOrder.forEach(m => {
                     if (!Array.isArray(userState.currentWorkout.exercises[m])) userState.currentWorkout.exercises[m] = [];
                 });
            } else {
                 userState.currentWorkout = { exercises: { arms: [], chest: [], back: [], abs: [], legs: [] } }; // Reset if malformed
            }

            userState.lastTotalAssignedCount = getTotalAssignedExercises();
            userState.currentMuscleIndex = parseInt(localStorage.getItem("currentMuscleIndex")) || 0;
            userState.weakMode = JSON.parse(localStorage.getItem("weakMode")) || {};
            userState.completedWorkout = JSON.parse(localStorage.getItem("completedWorkout")) || false;
            userState.lastCompletedCycleIndex = parseInt(localStorage.getItem("lastCompletedCycleIndex")) || 0;

            deathCountInput.value = userState.lastTotalAssignedCount > 0 ? userState.lastTotalAssignedCount : "1";

            if (userState.lastTotalAssignedCount > 0) {
                if (userState.completedWorkout) {
                    // --- MODIFIED: Show summary, but keep collapsed state logic in showSuccessMessage ---
                    const lastSummary = formatWorkoutForSummary(userState.currentWorkout);
                    if (lastSummary.total > 0) {
                         // Re-generate summary HTML on load if workout was completed
                         const summaryHtmlOnLoad = `
                            <h2>Session Complete! (${lastSummary.total} Exercises Done)</h2>
                            <img src="./images/Dale-Cooper_Thumbs_Up.gif" alt="Thumbs Up">
                            <div class="summary-toggle-container">
                                 <button id="summaryToggleAllBtn" class="toggle-all-btn">Expand All</button> <!-- Default: Expand -->
                             </div>
                            <div class="summary-exercises-list">
                                ${displayOrder.map(muscle => {
                                    if (lastSummary.exercises[muscle] && lastSummary.exercises[muscle].length > 0) {
                                        return `
                                            <div class="exercise-group">
                                                <div class="group-header">
                                                    <div class="group-title"><span>${muscle.charAt(0).toUpperCase() + muscle.slice(1)}</span></div>
                                                    <div class="group-toggle">🔻</div> <!-- Default: Collapsed -->
                                                </div>
                                                <div class="exercises-container" style="display: none;"> <!-- Default: Collapsed -->
                                                    ${lastSummary.exercises[muscle].map(ex => `
                                                        <div class="summary-exercise-item"> ${ex.name} (${ex.reps} ${ex.label})</div>
                                                    `).join('')}
                                                </div>
                                            </div>`;
                                    }
                                    return '';
                                }).join('')}
                            </div>
                            <div class="summary-done-container">
                                <button id="summaryDoneBtn" class="summary-done-btn">DONE</button>
                            </div>
                        `;
                        sessionSummaryContentEl.innerHTML = summaryHtmlOnLoad;
                        sessionSummaryContentEl.style.display = "block";
                        workoutDisplay.classList.add('showing-summary');
                        workoutDisplay.style.display = "block";

                        // Re-attach listeners for summary elements on load
                        const summaryGroupHeaders = sessionSummaryContentEl.querySelectorAll(".group-header");
                        summaryGroupHeaders.forEach(header => { header.addEventListener("click", () => { const group = header.closest('.exercise-group'); if (group) { toggleExerciseGroup(group, null, sessionSummaryContentEl, sessionSummaryContentEl.querySelector("#summaryToggleAllBtn")); } }); });
                        const summaryDoneBtn = sessionSummaryContentEl.querySelector("#summaryDoneBtn");
                        if (summaryDoneBtn) { summaryDoneBtn.addEventListener('click', () => { clearAllWorkouts(); }); }
                        const summaryToggleBtn = sessionSummaryContentEl.querySelector("#summaryToggleAllBtn");
                        if (summaryToggleBtn) { summaryToggleBtn.addEventListener('click', () => toggleAllGroups(sessionSummaryContentEl, summaryToggleBtn));}

                    } else {
                         // If workout completed but no exercises logged (unlikely), render normally
                         renderExercises();
                    }
                } else {
                    // If workout exists but wasn't marked completed, render it
                    renderExercises();
                }
            } else {
                 // No existing workout
                 deathCountInput.value = "1";
                 sessionSummaryContentEl.style.display = "none";
                 workoutDisplay.classList.remove('showing-summary');
                 workoutDisplay.style.display = "none"; // Ensure it's hidden
            }

            // Medal Showcase
            userState.workoutHistory = JSON.parse(localStorage.getItem("workoutHistory")) || [];
            userState.medalShowcaseCollapsed = JSON.parse(localStorage.getItem("medalShowcaseCollapsed")) || false;
            renderMedalShowcase(); // Render medals and apply collapsed state

            // Event Listeners
            generateBtn.addEventListener("click", handleGenerateClick);
            addOneBtn.addEventListener("click", handleAddOneClick);
            airBattlesCheckbox.addEventListener("change", handleBattleTypeToggle);
            groundBattlesCheckbox.addEventListener("change", handleBattleTypeToggle);
            workDoneBtn.addEventListener("click", showSuccessMessage);
            toggleAllBtn.addEventListener("click", () => toggleAllGroups()); // Uses defaults
            clearWorkoutBtn.addEventListener("click", clearAllWorkouts);
            completeAllBtn.addEventListener("click", completeAllExercises);
            clearCacheLink.addEventListener("click", () => { if (confirm("Are you sure you want to clear all saved data (workout, history, equipment, etc)?")) { localStorage.clear(); location.reload(); } });
            medalHeader.addEventListener('click', () => toggleMedalShowcase()); // Listener for medal toggle
        }

        // Start the app
        initializeApp();

    </script>
</body>
</html>
